#!/usr/bin/python
# -*- coding: UTF-8 -*-
 
import tkinter as tk
from tkinter import filedialog
import xlrd
import os
import openpyxl
from openpyxl import Workbook
from openpyxl import load_workbook
from openpyxl.styles import PatternFill
import tkinter.messagebox
# from tkinter import ttk
# import threading

def init0():
    global compare_result, filepath, filepath1, filepath2, readout, readout1, readout2, rows, row1, row2, column1, column2
    global readrows, readcolumns, readrows1, readcolumns1, readrows2, readcolumns2, getcellnum, filedifcol, orange_fill,file2difcol
    
    compare_result = []

    # ???????   
    filepath = "AAA"
    filepath1 = "A"
    filepath2 = "B"

    # ????????
    readout= []
    readout1=[]
    readout2=[]

    # rows?columns?????????EXCEL??????????
    # row1, row2????????1???2????column1?column2????????1???2???
    rows = 0
    columns =0
    row1 = 0
    row2 = 0
    column1 = 0
    column2 = 0

    finalrows = 0
    finalcolumns = 0
    finalrows1 = 0
    finalcolumns1 = 0
    finalrows2 = 0
    finalcolumns2 = 0

    # readrow?readcolumns??????????????????
    # readrows1?readcolumns1?????????1?????????????
    # readrows2?readcolumns2?????????1?????????????
    readrows = []
    readcolumns = []
    readrows1 = []
    readcolumns1 = []
    readrows2 = []
    readcolumns2 = []


    # getcellnum??????getcell???????
    getcellnum = 1

    # ?compare???????????????????????????????????
    file2difcol = {}

    # orange_fill????????????????
    orange_fill = PatternFill(fill_type='solid', fgColor="FFC125")

    green_fill = PatternFill(fill_type='solid', fgColor="AAC100")

               
               

# restart_begin???????text??????????
def restart_begin():
    init0()
    for k in range (3, row2+1):
        file2difcol[k] = 0

    print(filepath1)
    print(filepath2)

        
    text1.place_forget()
    text2.place_forget()
    Sbutton3.place_forget()
    # p1.pack_forget()
    


    
# Compare??????????Excel?????????????????????????
def compare():
    # print(readout1)
    # print(readout2)
    global readrow1, readrows, readcolumns1
    global filepath1, filepath2
    global sheetread1, sheetread2
    global Sbutton3
    global file2difcol,point1
    global p1
    point1=1
    spacenum=0

    

    wb1 = load_workbook( filepath1)
    sheetname1 = wb1.sheetnames
    ws1 = wb1.get_sheet_by_name("???")
    
    wb2 = load_workbook( filepath2)
    sheetname2 = wb2.sheetnames
    ws2 = wb2.get_sheet_by_name("???")

    # ??? file2difcol{}
    for k in range (3, row2+1):
        file2difcol[k]=0
        

    
 
    # ???????????????????????????????????? ????????????????
    for i in range(3, row1+1):
        point1=0
        
        if sheetread1.cell_value(i-1,0) == "" or sheetread1.cell_value(i-1,0) == "TBD" :
            spacenum += 1
            continue

        else:  
            for j in range (3, row2+1):
            
                """ 
                ??sheetread1???i?????????sheetread2?j????????????????2??????????????
                ??????2????????????????1?i??????????2?j?????????????????????????????
                ????????????1???1????????2??????????????????
                ????2?????????????????1????1???i??????????????????i??????????
             
                """
                if (sheetread1.cell_value(i-1,0)) == (sheetread2.cell_value(j-1, 0)) and sheetread2.cell_value(j-1,0) != "":
                    # point1???
                    point1 = 0
                    for pp in range(j+1, row2+1):
                        file2difcol[pp] += 1
                        
                    for n in range(1, min(column1+1,column2+1)):
                        if sheetread1.cell_value(i-1, n-1) == sheetread2.cell_value(j-1, n-1):
                            continue
                        else:
                            # ???1???2?i+1???n???????????
                            # print((readout[i * columns + j]),end = "     ")
                            ws1.cell(row=i, column=n).fill = orange_fill
                            ws2.cell(row=j, column=n).fill = orange_fill
                            # print(sheetread1.cell_value(i, 1), end=" ")
                    break    
                else:
                
                    # point1?????????2??1?????????????????????????????????1??i??????????
                    point1 = 1
                    file2difcol[j] += 1

                    """

                    ????????????j???????????i??????????????file2difcol[j]??????0?
                    file2difcol[j]??????
                    ???????????????????file2difcol[j]??????????????????????????????j????????????2?????
                
                    """

            # ????????i???????? 
            if point1 == 1 and sheetread1.cell_value(i-1,0) != "TBD":
                # print(sheetread1.cell_value()
                # print("????????????????{}".format(sheetread1.cell_value(i, 0)))
                for m in range (1, column1+1):
                    ws1.cell(row=i, column=m).fill = orange_fill
        
        

    # ??filedifcol????????????????1???????????????????????????????????????????
    # print(" ?????????????{}????".format(spacenum))
    
    for t in range(3, row2+1):
        # print("???????????????????{}".format(sheetread2.cell_value(t, 0)))
        # print(file2difcol[t])

        # ?????????????????????????????????????????????????????????????????????????
        if ((sheetread2.cell_value(t-1, 0)) == "" or (sheetread2.cell_value(t-1, 0)) == "TDB") and (sheetread2.cell_value(t-1, 1)) != "" :
            #print("????{}".format(t))
            #print("??2???????{}".format(sheetread2.cell_value(t-1, 1)))
            for t1 in range(3,row1+1):
                # print("??1????????{}".format(sheetread1.cell_value(t1-1, 1)))
                
                # ???????????????????????????????????????????????????????????
                if sheetread2.cell_value(t-1, 1) == sheetread1.cell_value(t1-1, 1):
                    # print(sheetread2.cell_value(t-1,1))
                    #print("??2????{}?????1?????????{}".format(t, sheetread2.cell_value(t-1, 1)))
                    
                    for y in range(1, min(column1+1,column2+1)):
                        if sheetread2.cell_value(t-1, y-1) == sheetread1.cell_value(t1-1, y-1):
                            
                            continue
                        else:
                            ws2.cell(row=t, column =y).fill = orange_fill
                            ws1.cell(row=t, column =y).fill = orange_fill

                    break
           
        if file2difcol[t]  == (row1-3-spacenum+1) and (sheetread2.cell_value(t-1, 0)) != "" and (sheetread2.cell_value(t-1, 0)) != "TBD":
            # print("??????????????????????{}".format(sheetread2.cell_value(t-1, 0)))
            for x in range(1,column2+1):
                ws2.cell(row=t, column =x).fill = orange_fill
        
                   


                
        # elif: sheetread2.cell_value(t-1,0) =="":

            

    try:
        wb1.save(filepath1)
        wb2.save(filepath2)
    except:
        tkinter.messagebox.showinfo("??", '????Excel?????')
        restart_begin()
    
    
   
    
    try:
        os.startfile(filepath2)
        # processclose == 1
    except:
        print("????????")
        exit()
        
    tkinter.messagebox.showinfo("????", '??????' + '\r\n'+ '????????')

    

def getcell():
    global getcellnum
    global filepath1, filepath2
    global rows, columns
    global readout1, readout2
    global readout
    global row1, row2, column1, column2, frow, fcolumn
    global readrows, readcolumns, readrows1, readcolumns1, readrows2, readcolumns2
    global sheetread, sheetread1, sheetread2
    global text1, text2,Sbutton3
    readout = []
    getcellnum *= -1
    file_path = filedialog.askopenfilename(title='??Excel??', filetypes=[('Excel', '*.xlsx')])
    
    filepath = file_path
    print(filepath)
    try:
        table = xlrd.open_workbook(filepath)
   
        sheetread = table.sheet_by_name("???")      
        
    except:
        tkinter.messagebox.showerror("??", "???EXCEL?????<???>?Sheet")
    
    rows = sheetread.nrows
    columns = sheetread.ncols
    # print("???{}".format(rows))
    # print("???{}".format(columns))

    if getcellnum == -1:
        filepath1 = file_path
        readout1 = readout
        row1 = rows
        column1 = columns
        # row_columnlist1 = row_columnlist
        readrows1 = readrows
        readcolumns1 = readcolumns
        sheetread1 = sheetread
        text1 = tk.Text(root)
        #text1.grid(row=4, column=100)
        text1.insert(1.0,filepath)
        text1.pack()
        text1.place(x=330, y=105,width=300,height=30)
        
    if getcellnum == 1:
        filepath2 = file_path
        readout2 = readout
        row2 = rows
        column2 =columns
        readrows2 = readrows
        readcolumns2 = readcolumns
        sheetread2 = sheetread
        text2 = tk.Text(root)
        # text2.grid(row=6, column=100)
        text2.insert(1.0,filepath)
        text2.pack()
        text2.place(x=330, y=155,width=300, height=30)
        
    
        if filepath1 != "A" and filepath2 != "B":
            Sbutton3 = tk.Button(root, text = "????", font=("??", 12, "bold"),fg='white',bg='green', command = compare)
            Sbutton3.place(x=400, y=10,height=40, width= 100)
            # print(filepath1)
            # print(frow)
            # print(filepath2)
            # print(fcolumn)
            
            #if row1 != row2 or column2 !=column2:
                #print("Excel one has different rows or columns")
                #tkinter.messagebox.showerror("??", "??EXCEL??????????\r\n ??????Excel?????????")
                #os._exit(0)
            

        else:
            print("??????????????")
          
    

                               
if __name__ ==  "__main__":

    init0()
    root = tk.Tk()
    root.geometry("800x400+200+200")
    root.title("????EXCEL?????")

    tkinter.messagebox.showinfo("????", '??????' + '\r\n'+ '\r\n'+ "?. ??????????????sheet????????" +'\r\n'+ '?????sheet?????????????????????????' + '\r\n'+
                                 '\r\n'+ "?. ??????????????????????????????????????????2??????"
                                )

    Sbutton1 = tk.Button(root, text = "???????",fg='blue',bg='white',font=("??", 10, "bold"),command = getcell)
    #Sbutton1.grid(row=4, column=50)
    Sbutton2 = tk.Button(root, text = "???????",fg='blue',bg='white',font=("??", 10, "bold"), command = getcell)
    # Sbutton2.grid(row=6, column=50)
    # Sbutton3 = tk.Button(root, text = "????")

    Sbutton4 = tk.Button(root, text = "??", fg='blue',bg='yellow', font=("??", 12, "bold"),command = restart_begin)

    # Sbutton4.grid(row=8, column=50)
    
    Sbutton1.place(x=200, y=100,width=120, height=40)
    Sbutton2.place(x=200,y=150, width=120, height=40)
    Sbutton4.place(x=400,y=200, width=100, height=40)
                

    root.mainloop()
